package com.example.irmusicsync

import android.hardware.ConsumerIrManager

class IRController(private val irManager: ConsumerIrManager) {
    companion object {
        private const val CARRIER_FREQUENCY = 38000 // 38kHz carrier frequency
    }

    // IR patterns for all available colors
    private val OFF_PATTERN = intArrayOf(
        9350, 4450,
        650, 500, 600, 550, 650, 500, 650, 500,
        600, 550, 650, 500, 650, 500, 600, 550,
        650, 1600, 600, 1650, 600, 1650, 650, 1600,
        600, 550, 600, 1650, 600, 1650, 600, 1650,
        650, 500, 600, 1650, 600, 550, 600, 550,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 550, 600, 1650, 600, 1650,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600
    )

    private val ON_PATTERN = intArrayOf(
        9400, 4450,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600, 550, 600, 1650, 600, 1600, 650, 1600,
        650, 1600, 650, 1600, 650, 500, 650, 500,
        650, 500, 650, 500, 650, 500, 650, 500,
        650, 500, 650, 500, 650, 1600, 650, 1600,
        650, 1600, 650, 1600, 650, 1600, 650, 1600,
        650
    )

    private val RED_PATTERN = intArrayOf(
        9350, 4450,
        650, 500, 650, 500, 650, 500, 650, 500,
        650, 500, 650, 500, 650, 500, 650, 500,
        650, 1600, 650, 1600, 600, 1650, 650, 1600,
        600, 550, 600, 1650, 650, 1600, 600, 1650,
        650, 500, 600, 1650, 600, 1650, 600, 550,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 550, 600, 550, 600, 1650,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600
    )

    private val BLUE_PATTERN = intArrayOf(
        9350, 4450,
        650, 500, 650, 500, 650, 500, 650, 500,
        650, 500, 650, 500, 650, 500, 650, 500,
        650, 1600, 650, 1600, 650, 1600, 650, 1600,
        650, 500, 650, 1600, 650, 1600, 650, 1600,
        600, 1650, 650, 500, 600, 1650, 600, 550,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 550, 600, 1650, 600, 550, 600, 1650,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600
    )

    private val GREEN_PATTERN = intArrayOf(
        9350, 4450,
        650, 500, 650, 500, 650, 500, 650, 500,
        650, 500, 650, 500, 650, 500, 650, 500,
        600, 1650, 650, 1600, 600, 1650, 700, 1550,
        650, 500, 600, 1650, 650, 1600, 600, 1650,
        600, 550, 600, 550, 600, 1650, 600, 550,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 1650, 600, 550, 600, 1650,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600
    )

    private val WHITE_PATTERN = intArrayOf(
        9400, 4450,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 1600, 650, 1600, 650, 1600,
        650, 500, 650, 1600, 650, 1600, 650, 1600,
        650, 1600, 650, 1600, 650, 1600, 650, 500,
        650, 500, 650, 500, 650, 500, 600, 550,
        650, 500, 650, 500, 600, 550, 650, 1600,
        600, 1650, 650, 1600, 600, 1650, 600, 1650,
        600
    )

    private val LIGHT_GREEN_PATTERN = intArrayOf(
        9350, 4450,
        650, 500, 650, 500, 650, 500, 650, 500,
        650, 500, 650, 500, 650, 500, 650, 500,
        650, 1600, 650, 1600, 650, 1600, 650, 1600,
        600, 550, 650, 1600, 600, 1650, 600, 1650,
        600, 550, 600, 550, 600, 1650, 600, 1650,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 1650, 600, 550, 600, 550,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600
    )

    private val VERY_LIGHT_GREEN_PATTERN = intArrayOf(
        9350, 4450,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600, 550, 600, 1650, 600, 1650, 600, 1650,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600, 550, 600, 1650, 600, 1650, 600, 1650,
        600
    )

    private val TURQUOISE_PATTERN = intArrayOf(
        9350, 4500,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 550, 600, 550, 600, 500, 650, 500,
        650, 1600, 650, 1600, 650, 1600, 650, 1600,
        650, 500, 650, 1600, 650, 1600, 650, 1600,
        650, 500, 650, 500, 650, 1600, 650, 500,
        650, 1600, 600, 550, 650, 500, 600, 550,
        600, 1650, 600, 1650, 600, 550, 600, 1650,
        600, 550, 600, 1650, 600, 1650, 600, 1650,
        600
    )

    private val ORANGE_PATTERN = intArrayOf(
        9400, 4450,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600, 550, 600, 1650, 600, 1650, 600, 1650,
        600, 550, 600, 1650, 600, 1650, 600, 1650,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600
    )

    private val YELLOW_PATTERN = intArrayOf(
        9350, 4450,
        700, 450, 650, 500, 650, 500, 650, 500,
        650, 500, 650, 500, 650, 500, 650, 500,
        650, 1600, 650, 1600, 650, 1600, 600, 1650,
        650, 500, 600, 1650, 650, 1600, 600, 1650,
        600, 550, 600, 1650, 600, 550, 600, 550,
        600, 1650, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 550, 600, 1650, 600, 1650,
        600, 550, 600, 1650, 600, 1650, 600, 1650,
        600
    )

    private val PURPLE_PATTERN = intArrayOf(
        9350, 4450,
        650, 500, 650, 500, 650, 500, 650, 500,
        600, 550, 650, 500, 650, 500, 600, 550,
        650, 1600, 600, 1650, 600, 1650, 600, 1650,
        600, 550, 600, 1650, 600, 1650, 600, 1650,
        600, 1650, 600, 550, 600, 1650, 600, 1650,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 550, 600, 1650, 600, 550, 600, 550,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600
    )

    private val LIGHT_PURPLE_PATTERN = intArrayOf(
        9400, 4450,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600, 550, 600, 1650, 600, 1650, 600, 1650,
        600, 1650, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 550, 600, 500, 700, 450,
        650, 500, 650, 1600, 650, 1600, 650, 1600,
        650, 500, 650, 1600, 650, 1600, 650, 1600,
        650
    )

    private val PINK_PATTERN = intArrayOf(
        9350, 4450,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600, 550, 600, 1650, 600, 1650, 600, 1650,
        600, 1650, 600, 550, 600, 1650, 600, 550,
        600, 1650, 600, 550, 650, 500, 600, 500,
        650, 500, 650, 1600, 650, 500, 650, 1600,
        650, 500, 650, 1600, 650, 1600, 650, 1600,
        650
    )

    private val BRIGHTNESS_UP_PATTERN = intArrayOf(
        9400, 4450,
        650, 500, 600, 550, 600, 550, 650, 500,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600, 550, 600, 1650, 600, 1650, 600, 1650,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600
    )

    private val BRIGHTNESS_DOWN_PATTERN = intArrayOf(
        9400, 4450,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 1650, 600, 1650, 600, 1650, 600, 1650,
        600, 550, 600, 1650, 600, 1650, 600, 1650,
        600, 1650, 600, 550, 600, 550, 600, 550,
        600, 550, 600, 550, 600, 550, 600, 550,
        600, 550, 600, 1650, 600, 1650, 600, 1600,
        650, 1600, 650, 1600, 650, 1600, 650, 1600,
        650
    )

    fun sendCommand(command: IRCommand) {
        val pattern = getPatternForCommand(command)
        pattern?.let {
            try {
                irManager.transmit(CARRIER_FREQUENCY, it)
                println("IR Signal sent: ${command.color}")
            } catch (e: Exception) {
                println("IR Transmission failed: ${e.message}")
            }
        }
    }

    private fun getPatternForCommand(command: IRCommand): IntArray? {
        return when (command.color) {
            IRCommand.Color.RED -> RED_PATTERN
            IRCommand.Color.GREEN -> GREEN_PATTERN
            IRCommand.Color.BLUE -> BLUE_PATTERN
            IRCommand.Color.WHITE -> WHITE_PATTERN
            IRCommand.Color.LIGHT_GREEN -> LIGHT_GREEN_PATTERN
            IRCommand.Color.VERY_LIGHT_GREEN -> VERY_LIGHT_GREEN_PATTERN
            IRCommand.Color.TURQUOISE -> TURQUOISE_PATTERN
            IRCommand.Color.ORANGE -> ORANGE_PATTERN
            IRCommand.Color.YELLOW -> YELLOW_PATTERN
            IRCommand.Color.PURPLE -> PURPLE_PATTERN
            IRCommand.Color.LIGHT_PURPLE -> LIGHT_PURPLE_PATTERN
            IRCommand.Color.PINK -> PINK_PATTERN

            else -> null
        }
    }

    // Additional control methods
    fun brightnessUp() {
        try {
            irManager.transmit(CARRIER_FREQUENCY, BRIGHTNESS_UP_PATTERN)
            println("Brightness up signal sent")
        } catch (e: Exception) {
            println("Brightness up failed: ${e.message}")
        }
    }

    fun brightnessDown() {
        try {
            irManager.transmit(CARRIER_FREQUENCY, BRIGHTNESS_DOWN_PATTERN)
            println("Brightness down signal sent")
        } catch (e: Exception) {
            println("Brightness down failed: ${e.message}")
        }
    }

    // Send a sequence of colors for smooth transitions
    fun sendColorSequence(colors: List<IRCommand.Color>, delayMs: Long = 150) {
        Thread {
            colors.forEach { color ->
                val command = IRCommand().apply { this.color = color }
                sendCommand(command)
                try {
                    Thread.sleep(delayMs)
                } catch (e: InterruptedException) {
                    Thread.currentThread().interrupt()
                    return@Thread
                }
            }
        }.start()
    }
}